<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }
    h2 {
      margin-top: 40px;
    }
    .user-card, .chat-box {
      background: white;
      padding: 16px;
      margin: 10px 0;
      border-radius: 10px;
      box-shadow: 0 0 6px rgba(0,0,0,0.05);
    }
    .user-card img {
      width: 60px;
      height: 60px;
      border-radius: 100%;
      object-fit: cover;
      border: 2px solid #ccc;
      margin-right: 12px;
    }
    .user-info {
      display: flex;
      align-items: center;
    }
    .user-info div {
      flex-grow: 1;
    }
    .reset {
      margin-top: 8px;
    }
    .reset input {
      padding: 6px;
      width: 200px;
      margin-right: 8px;
    }
    .reset button {
      padding: 6px 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .delete-btn {
      background: #dc3545;
    }
    .chat-box pre {
      background: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    button.clear-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1>Admin Panel</h1>

  <h2>All Users</h2>
  <div id="userList"></div>

  <h2>All Conversations</h2>
  <button class="clear-btn" onclick="clearRecentChats()">Remove All Recent Chats</button>
  <div id="chatList"></div>

  <h2>Messages from Users</h2>
  <div id="messageList"></div>

  <script>
    // Restrict access to TazDaz only
    const currentUser = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!currentUser || currentUser.username !== "TazDaz") {
      alert("Access denied.");
      window.location.href = "index.html";
    }

    // USERS
    const users = JSON.parse(localStorage.getItem("users") || "[]");
    const userList = document.getElementById("userList");

    users.forEach(user => {
      const div = document.createElement("div");
      div.className = "user-card";
      div.innerHTML = `
        <div class="user-info">
          <img src="${user.profilePic || 'https://via.placeholder.com/60'}" />
          <div>
            <strong>@${user.username}</strong><br>
            Nickname: ${user.nickname}<br>
            Sex: ${user.sex}
          </div>
        </div>
        <div class="reset">
          <input type="text" id="reset-${user.username}" placeholder="New password for ${user.username}">
          <button onclick="resetPassword('${user.username}')">Reset Password</button>
          ${user.username !== "TazDaz" ? `<button class="delete-btn" onclick="deleteUser('${user.username}')">Delete User</button>` : ""}
        </div>
      `;
      userList.appendChild(div);
    });

    function resetPassword(username) {
      const input = document.getElementById("reset-" + username);
      const newPass = input.value.trim();
      if (!newPass) {
        alert("Enter a password.");
        return;
      }
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const updated = users.map(u => {
        if (u.username === username) u.password = newPass;
        return u;
      });
      localStorage.setItem("users", JSON.stringify(updated));
      alert(`Password for ${username} updated!`);
      input.value = "";
    }

    function deleteUser(username) {
      if (!confirm(`Are you sure you want to delete @${username} and all their data?`)) return;

      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const updatedUsers = users.filter(u => u.username !== username);
      localStorage.setItem("users", JSON.stringify(updatedUsers));

      const characters = JSON.parse(localStorage.getItem("characters") || "[]");
      const filteredChars = characters.filter(c => c.createdBy !== username);
      localStorage.setItem("characters", JSON.stringify(filteredChars));

      Object.keys(localStorage).forEach(key => {
        if (key.startsWith("chat_history_" + username)) {
          localStorage.removeItem(key);
        }
      });

      alert(`@${username} has been deleted.`);
      location.reload();
    }

    // CHATS
    const chatList = document.getElementById("chatList");
    const chatKeys = Object.keys(localStorage).filter(k => k.startsWith("chat_history_"));

    chatKeys.forEach(key => {
      const data = JSON.parse(localStorage.getItem(key));
      const [, username, character] = key.split("_", 3);
      const messages = data.filter(m => m.role !== "system");

      const div = document.createElement("div");
      div.className = "chat-box";
      div.innerHTML = `
        <strong>${username} â†’ ${character}</strong>
        <pre>${messages.map(m => `${m.role === 'user' ? username : character}: ${m.content}`).join('\n\n')}</pre>
      `;
      chatList.appendChild(div);
    });

    function clearRecentChats() {
      if (!confirm("This will remove chat history from the admin page only. User conversations will stay saved. Proceed?")) return;
      document.getElementById("chatList").innerHTML = "<p>Chat list cleared from view.</p>";
    }

    // MESSAGES
    const messages = JSON.parse(localStorage.getItem("adminMessages") || "[]");
    const messageList = document.getElementById("messageList");

    if (messages.length === 0) {
      messageList.innerHTML = "<p>No messages.</p>";
    } else {
      messages.forEach(m => {
        const div = document.createElement("div");
        div.className = "user-card";
        div.innerHTML = `<strong>@${m.from}</strong> <em>${m.date}</em><br>${m.text}`;
        messageList.appendChild(div);
      });
    }
  </script>

</body>
</html>
