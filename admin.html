<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }
    h2 {
      margin-top: 40px;
    }
    .user-card, .chat-box {
      background: white;
      padding: 16px;
      margin: 10px 0;
      border-radius: 10px;
      box-shadow: 0 0 6px rgba(0,0,0,0.05);
    }
    .user-card img {
      width: 60px;
      height: 60px;
      border-radius: 100%;
      object-fit: cover;
      border: 2px solid #ccc;
      margin-right: 12px;
    }
    .user-info {
      display: flex;
      align-items: center;
    }
    .user-info div {
      flex-grow: 1;
    }
    .reset {
      margin-top: 8px;
    }
    .reset input {
      padding: 6px;
      width: 200px;
      margin-right: 8px;
    }
    .reset button {
      padding: 6px 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .chat-box pre {
      background: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

  <h1>Admin Panel</h1>

  <h2>All Users</h2>
  <div id="userList"></div>

  <h2>All Conversations</h2>
  <div id="chatList"></div>

  <script>
    const users = JSON.parse(localStorage.getItem("users") || "[]");
    const userList = document.getElementById("userList");

    users.forEach(user => {
      const div = document.createElement("div");
      div.className = "user-card";
      div.innerHTML = `
        <div class="user-info">
          <img src="${user.profilePic || 'https://via.placeholder.com/60'}" />
          <div>
            <strong>@${user.username}</strong><br>
            Nickname: ${user.nickname}<br>
            Sex: ${user.sex}
          </div>
        </div>
        <div class="reset">
          <input type="text" id="reset-${user.username}" placeholder="New password for ${user.username}">
          <button onclick="resetPassword('${user.username}')">Reset Password</button>
        </div>
      `;
      userList.appendChild(div);
    });

    function resetPassword(username) {
      const input = document.getElementById("reset-" + username);
      const newPass = input.value.trim();
      if (!newPass) {
        alert("Enter a password.");
        return;
      }
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const updated = users.map(u => {
        if (u.username === username) u.password = newPass;
        return u;
      });
      localStorage.setItem("users", JSON.stringify(updated));
      alert(`Password for ${username} updated!`);
      input.value = "";
    }

    // Show conversations
    const chatList = document.getElementById("chatList");
    const keys = Object.keys(localStorage).filter(k => k.startsWith("chat_history_"));

    keys.forEach(key => {
      const data = JSON.parse(localStorage.getItem(key));
      const [, username, character] = key.split("_", 3);
      const messages = data.filter(m => m.role !== "system");

      const div = document.createElement("div");
      div.className = "chat-box";
      div.innerHTML = `
        <strong>${username} &rarr; ${character}</strong>
        <pre>${messages.map(m => `${m.role === 'user' ? username : character}: ${m.content}`).join('\n\n')}</pre>
      `;
      chatList.appendChild(div);
    });
  </script>

</body>
</html>
