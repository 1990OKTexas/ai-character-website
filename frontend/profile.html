<!DOCTYPE html>
<html>
<head>
  <title>User Profile</title>
  <style>
    /* your same styles here, no change needed */
  </style>
</head>
<body>

  <button class="home-btn" onclick="location.href='index.html'">Go Back Home</button>

  <div class="profile-container">
    <img id="profilePic" class="profile-pic" src="" alt="Profile Picture" />
    <div id="adminTag" style="font-size:12px;color:purple;margin-top:10px;display:none;">ADMIN</div>
    <h2 id="displayName"></h2>
    <div class="meta" id="signupDate"></div>
    <div id="statusBadge" class="status">Online</div>
    <button id="editBtn" onclick="showEditForm()" style="margin-top: 12px; display: none;">Edit Profile</button>
  </div>

  <div class="edit-form" id="editForm">
    <input type="text" id="editNickname" placeholder="Nickname">
    <input type="text" id="editUsername" placeholder="Username (no @)">
    <select id="editSex">
      <option>Male</option>
      <option>Female</option>
      <option>Non-binary</option>
      <option>N/A</option>
    </select>
    <input type="text" id="editPicURL" placeholder="Profile Picture URL">
    <input type="file" id="editPicFile" accept="image/*">
    <img id="editPreview" src="" style="width:100px;height:100px;border-radius:50%;margin-top:10px;">
    
    <p style="margin-top:20px;"><a href="#" onclick="togglePasswordChange()">Create new password</a></p>
    <div id="passwordSection" style="display:none;">
      <input type="password" id="oldPass" placeholder="Old Password">
      <input type="password" id="newPass" placeholder="New Password">
      <input type="password" id="confirmPass" placeholder="Re-enter New Password">
    </div>

    <button onclick="saveProfile()">Save</button>
  </div>

  <div class="char-section">
    <h3 style="text-align:center;">My Characters</h3>
    <div id="userCharacters"></div>
  </div>

  <script>
    const API_BASE = 'https://ai-character-backend.onrender.com';
    const params = new URLSearchParams(window.location.search);
    const viewingUser = params.get("user");
    let currentUser = null;
    let user = null;

    async function loadProfile() {
      const res = await fetch(`${API_BASE}/api/users/me`, { credentials: "include" });
      if (res.ok) {
        currentUser = await res.json();
      }

      const userRes = viewingUser
        ? await fetch(`${API_BASE}/api/users/${viewingUser}`)
        : await fetch(`${API_BASE}/api/users/me`, { credentials: "include" });

      if (!userRes.ok) {
        alert("User not found or not logged in.");
        location.href = "index.html";
        return;
      }

      user = await userRes.json();

      const isOwner = currentUser && user.username === currentUser.username;

      document.getElementById("displayName").textContent = "@" + user.username;
      document.getElementById("signupDate").textContent = "Signed up on: " + new Date(user.signupDate || Date.now()).toLocaleDateString();
      document.getElementById("profilePic").src = user.profilePic || "https://via.placeholder.com/160?text=User";

      if (user.username === "TazDaz") {
        document.getElementById("adminTag").style.display = "block";
      }

      if (isOwner) {
        document.getElementById("editBtn").style.display = "inline-block";
      }

      loadCharacters(user.username, isOwner);
    }

    async function loadCharacters(username, isOwner) {
      const res = await fetch(`${API_BASE}/api/characters`);
      const characters = await res.json();
      const myCharacters = characters.filter(c => c.createdBy === username);
      const container = document.getElementById("userCharacters");

      if (myCharacters.length === 0) {
        container.innerHTML = "<p style='text-align:center;'>This user hasnâ€™t created any characters yet.</p>";
      } else {
        myCharacters.forEach(char => {
          const div = document.createElement("div");
          div.className = "char-card";
          div.innerHTML = `
            <img src="${char.image}" />
            <h4>${char.name}</h4>
            <button onclick="location.href='chat.html?name=${encodeURIComponent(char.name)}'">Chat Now</button>
            ${isOwner ? `
              <button onclick="editCharacter('${char.name}')">Edit</button>
              <button class="delete-btn" onclick="deleteCharacter('${char.name}')">Delete</button>
            ` : ""}
          `;
          container.appendChild(div);
        });
      }
    }

    function showEditForm() {
      document.getElementById("editForm").style.display = "block";
      document.getElementById("editNickname").value = user.nickname;
      document.getElementById("editUsername").value = user.username;
      document.getElementById("editSex").value = user.sex || "N/A";
      document.getElementById("editPicURL").value = user.profilePic || "";
      document.getElementById("editPreview").src = user.profilePic || "https://via.placeholder.com/100";
    }

    function togglePasswordChange() {
      const section = document.getElementById("passwordSection");
      section.style.display = section.style.display === "none" ? "block" : "none";
    }

    document.getElementById("editPicFile").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = evt => {
          document.getElementById("editPreview").src = evt.target.result;
          document.getElementById("editPicURL").value = "";
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById("editPicURL").addEventListener("input", e => {
      if (e.target.value) {
        document.getElementById("editPreview").src = e.target.value;
        document.getElementById("editPicFile").value = "";
      }
    });

    async function saveProfile() {
      const updated = {
        nickname: document.getElementById("editNickname").value.trim(),
        username: document.getElementById("editUsername").value.trim(),
        sex: document.getElementById("editSex").value,
        profilePic: document.getElementById("editPreview").src
      };

      const oldPass = document.getElementById("oldPass").value;
      const newPass = document.getElementById("newPass").value;
      const confirm = document.getElementById("confirmPass").value;

      if (oldPass || newPass || confirm) {
        if (newPass !== confirm) return alert("Passwords do not match.");
        updated.oldPassword = oldPass;
        updated.newPassword = newPass;
      }

      const res = await fetch(`${API_BASE}/api/users/update`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(updated)
      });

      if (res.ok) {
        alert("Profile updated!");
        location.reload();
      } else {
        alert("Update failed.");
      }
    }

    async function editCharacter(name) {
      location.href = `edit.html?name=${encodeURIComponent(name)}`;
    }

    async function deleteCharacter(name) {
      if (!confirm(`Delete ${name}? This cannot be undone.`)) return;
      await fetch(`${API_BASE}/api/characters/${encodeURIComponent(name)}`, {
        method: "DELETE",
        credentials: "include"
      });
      location.reload();
    }

    loadProfile();
  </script>
</body>
</html>
