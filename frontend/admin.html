<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }
    h2 {
      margin-top: 40px;
    }
    .user-card, .chat-box {
      background: white;
      padding: 16px;
      margin: 10px 0;
      border-radius: 10px;
      box-shadow: 0 0 6px rgba(0,0,0,0.05);
    }
    .user-card img {
      width: 60px;
      height: 60px;
      border-radius: 100%;
      object-fit: cover;
      border: 2px solid #ccc;
      margin-right: 12px;
    }
    .user-info {
      display: flex;
      align-items: center;
    }
    .user-info div {
      flex-grow: 1;
    }
    .reset {
      margin-top: 8px;
    }
    .reset input {
      padding: 6px;
      width: 200px;
      margin-right: 8px;
    }
    .reset button {
      padding: 6px 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .delete-btn {
      background: #dc3545;
    }
    .chat-box pre {
      background: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    button.clear-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1>Admin Panel</h1>

  <h2>All Users</h2>
  <div id="userList"></div>

  <h2>All Conversations</h2>
  <button class="clear-btn" onclick="clearRecentChats()">Clear From View</button>
  <div id="chatList"></div>

  <h2>Messages from Users</h2>
  <button class="clear-btn" onclick="deleteAllMessages()">Delete All Messages</button>
  <div id="messageList"></div>

  <script>
    const API_BASE = 'https://ai-character-backend.onrender.com';

    async function init() {
      const current = await fetch(`${API_BASE}/api/users/me`, { credentials: 'include' });
      const currentUser = await current.json();
      if (!currentUser || currentUser.username !== "TazDaz") {
        alert("Access denied.");
        window.location.href = "index.html";
        return;
      }

      // Load all users
      const usersRes = await fetch(`${API_BASE}/api/users`);
      const users = await usersRes.json();
      const userList = document.getElementById("userList");

      users.forEach(user => {
        const div = document.createElement("div");
        div.className = "user-card";
        div.innerHTML = `
          <div class="user-info">
            <img src="${user.profilePic || 'https://via.placeholder.com/60'}" />
            <div>
              <strong>@${user.username}</strong><br>
              Nickname: ${user.nickname}<br>
              Sex: ${user.sex}
            </div>
          </div>
          <div class="reset">
            <input type="text" id="reset-${user.username}" placeholder="New password for ${user.username}">
            <button onclick="resetPassword('${user.username}')">Reset Password</button>
            ${user.username !== "TazDaz" ? `<button class="delete-btn" onclick="deleteUser('${user.username}')">Delete User</button>` : ""}
          </div>
        `;
        userList.appendChild(div);
      });

      // Load messages
      const msgRes = await fetch(`${API_BASE}/api/admin/messages`);
      const messages = await msgRes.json();
      const messageList = document.getElementById("messageList");
      if (!messages.length) {
        messageList.innerHTML = "<p>No messages.</p>";
      } else {
        messages.forEach(m => {
          const div = document.createElement("div");
          div.className = "user-card";
          div.innerHTML = `<strong>@${m.from}</strong> <em>${m.date}</em><br>${m.text}`;
          messageList.appendChild(div);
        });
      }

      // Load chats
      const chatRes = await fetch(`${API_BASE}/api/admin/chat`);
      const chats = await chatRes.json();
      const chatList = document.getElementById("chatList");
      chats.forEach(chat => {
        const div = document.createElement("div");
        div.className = "chat-box";
        div.innerHTML = `
          <strong>${chat.username} â†’ ${chat.character}</strong>
          <pre>${chat.messages.map(m => `${m.role === 'user' ? chat.username : chat.character}: ${m.content}`).join('\n\n')}</pre>
        `;
        chatList.appendChild(div);
      });
    }

    async function resetPassword(username) {
      const input = document.getElementById("reset-" + username);
      const newPass = input.value.trim();
      if (!newPass) return alert("Enter a password.");

      await fetch(`${API_BASE}/api/users/reset-password`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, newPassword: newPass })
      });

      alert(`Password for @${username} reset!`);
      input.value = "";
    }

    async function deleteUser(username) {
      if (!confirm(`Delete @${username} and all data?`)) return;
      await fetch(`${API_BASE}/api/users/${username}`, { method: "DELETE" });
      alert(`@${username} deleted.`);
      location.reload();
    }

    async function deleteAllMessages() {
      if (!confirm("Delete all guest messages?")) return;
      await fetch(`${API_BASE}/api/admin/messages`, { method: "DELETE" });
      document.getElementById("messageList").innerHTML = "<p>No messages.</p>";
      alert("All messages deleted.");
    }

    function clearRecentChats() {
      document.getElementById("chatList").innerHTML = "<p>Chat list cleared from view.</p>";
    }

    init();
  </script>

</body>
</html>
