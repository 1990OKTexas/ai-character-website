<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <style>
    /* (same CSS as before, unchanged) */
  </style>
</head>
<body>
  <div class="chat-header">
    <button class="go-home" onclick="window.location.href='index.html'">Go Home</button>
    <img id="charImage" src="" alt="Character Image">
    <div class="online">‚óè Online</div>
    <div class="creator" id="creatorName"></div>
    <div class="description"><strong>Description:</strong> <span id="charDesc"></span></div>
  </div>
  <div class="chat-box" id="chatBox"></div>
  <div class="typing" id="typingStatus"></div>
  <div class="input-area">
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>
    <button onclick="startOver()">Start Over</button>
  </div>

  <script>
    const API_BASE = 'https://ai-character-backend.onrender.com';
    const params = new URLSearchParams(window.location.search);
    const charName = params.get("name");
    let character = null;
    let user = null;
    let messages = [];

    const chatBox = document.getElementById("chatBox");
    const input = document.getElementById("messageInput");
    const typingStatus = document.getElementById("typingStatus");

    async function init() {
      try {
        const userRes = await fetch(`${API_BASE}/api/users/me`, { credentials: 'include' });
        if (!userRes.ok) throw new Error("Not logged in.");
        user = await userRes.json();
      } catch {
        document.body.innerHTML = "<p style='text-align:center;padding:20px;'>Please log in to chat.</p>";
        return;
      }

      try {
        const charRes = await fetch(`${API_BASE}/api/characters`);
        const charList = await charRes.json();
        character = charList.find(c => c.name === charName);

        if (!character) throw new Error("Character not found.");

        document.getElementById("charImage").src = character.image;
        document.getElementById("charDesc").textContent = character.description;
        document.getElementById("creatorName").innerHTML = `Created by: <a href='profile.html?user=${character.createdBy}' style='color:#007bff;'>@${character.createdBy}</a>`;
      } catch {
        document.body.innerHTML = "<p style='text-align:center;padding:20px;'>Character not found.</p>";
        return;
      }

      // Load previous messages
      const res = await fetch(`${API_BASE}/api/chat/history?username=${user.username}&character=${charName}`);
      messages = await res.json();
      renderMessages();
    }

    function renderMessages() {
      chatBox.innerHTML = "";
      messages.forEach(m => {
        const div = document.createElement("div");
        div.className = "message " + (m.role === "user" ? "user" : "assistant");
        div.innerHTML = `
          <img src="${m.role === "user" ? (user.profilePic || 'https://via.placeholder.com/32?text=U') : character.image}">
          <p>${m.content}</p>
        `;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      messages.push({ role: "user", content: text });
      renderMessages();
      input.value = "";
      typingStatus.textContent = "Typing...";

      try {
        const res = await fetch(`${API_BASE}/api/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({
            characterName: character.name,
            userMessage: text
          })
        });

        const data = await res.json();
        messages.push({ role: "assistant", content: data.reply });
        typingStatus.textContent = "";
        renderMessages();
      } catch (err) {
        messages.push({ role: "assistant", content: "Something went wrong." });
        typingStatus.textContent = "";
        renderMessages();
      }
    }

    async function startOver() {
      if (!confirm("Start this chat over?")) return;
      messages = [];
      await fetch(`${API_BASE}/api/chat/history?username=${user.username}&character=${charName}`, {
        method: "DELETE",
        credentials: "include"
      });
      renderMessages();
    }

    init();
  </script>
</body>
</html>
