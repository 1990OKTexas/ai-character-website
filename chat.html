<!DOCTYPE html>
<html>
  <head>
    <title>Chat</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f4f4f4;
      }
      .container {
        max-width: 500px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 0 6px rgba(0,0,0,0.1);
      }
      .home-btn {
        position: fixed;
        top: 10px;
        left: 10px;
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        z-index: 1001;
      }
      .character-img {
        display: block;
        margin: 0 auto 10px;
        width: 160px;
        height: 160px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid #ccc;
      }
      #charName {
        text-align: center;
        font-size: 18px;
        margin: 10px 0 5px;
      }
      .description {
        text-align: center;
        font-size: 12px;
        color: #555;
        margin-bottom: 20px;
      }
      .chat-area {
        border: 1px solid #ccc;
        border-radius: 8px;
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        margin-bottom: 10px;
        background: #fefefe;
      }
      #messageInput {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-top: 6px;
      }
      #sendBtn {
        margin-top: 6px;
        padding: 8px 12px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 300px;
        text-align: center;
      }
      .modal-content input,
      .modal-content button {
        width: 100%;
        margin-top: 10px;
        padding: 8px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      .modal-content input[type="color"] {
        padding: 2px;
        height: 40px;
      }
      .modal-content button {
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>

    <button class="home-btn" onclick="location.href='index.html'">Go Home</button>

    <div class="modal" id="setupModal">
      <div class="modal-content">
        <h3>Enter Your Chat Name</h3>
        <input type="text" id="username" placeholder="Your name" />
        <h4>Pick your color</h4>
        <input type="color" id="color" value="#007bff" />
        <button onclick="startChat()">Chat Now</button>
      </div>
    </div>

    <div class="container">
      <img id="charImg" class="character-img" src="" alt="Character Image" />
      <h2 id="charName"></h2>
      <div class="description">
        <strong>Description:</strong> <span id="charDesc">Loading...</span>
      </div>

      <div class="chat-area" id="chatbox"></div>

      <input type="text" id="messageInput" placeholder="Type a message..." disabled />
      <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const charName = urlParams.get('name');
      const characters = JSON.parse(localStorage.getItem("characters") || "[]");
      const character = characters.find(c => c.name === charName);

      if (character) {
        document.getElementById("charImg").src = character.image;
        document.getElementById("charName").textContent = character.name;
        document.getElementById("charDesc").textContent = character.description;
      }

      let username = "";
      let userColor = "#007bff";
      let locked = true;

      function startChat() {
        const nameInput = document.getElementById("username").value.trim();
        const colorInput = document.getElementById("color").value;
        if (!nameInput) {
          alert("Please enter your username.");
          return;
        }

        username = nameInput;
        userColor = colorInput;
        locked = false;

        document.getElementById("messageInput").disabled = false;
        document.getElementById("sendBtn").disabled = false;
        document.getElementById("setupModal").style.display = "none";
      }

      async function sendMessage() {
        if (locked) return;
        const input = document.getElementById("messageInput");
        const text = input.value.trim();
        if (!text) return;

        const chatbox = document.getElementById("chatbox");
        const msg = document.createElement("div");
        msg.innerHTML = `<strong style="color:${userColor}">${username}:</strong> ${text}`;
        chatbox.appendChild(msg);
        chatbox.scrollTop = chatbox.scrollHeight;
        input.value = "";

        const systemPrompt = `You are ${character.name}, a charming AI character. Answer like you're having a real conversation.`;

        try {
          const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer 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"
            },
            body: JSON.stringify({
              model: "mixtral-8x7b-32768",
              messages: [
                { role: "system", content: systemPrompt },
                { role: "user", content: text }
              ]
            })
          });

          const data = await response.json();

          let aiText = "Hmm...";
          if (data && data.choices && data.choices[0] && data.choices[0].message) {
            aiText = data.choices[0].message.content;
          } else if (data.error) {
            aiText = `Error: ${data.error.message}`;
          }

          const aiReply = document.createElement("div");
          aiReply.innerHTML = `<strong style="color:#ff6600">${character.name}:</strong> ${aiText}`;
          chatbox.appendChild(aiReply);
          chatbox.scrollTop = chatbox.scrollHeight;

        } catch (err) {
          const fail = document.createElement("div");
          fail.innerHTML = `<strong style="color:red">${character.name}:</strong> Failed to contact AI: ${err.message}`;
          chatbox.appendChild(fail);
        }
      }
    </script>
  </body>
</html>
