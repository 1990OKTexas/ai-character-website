<!DOCTYPE html>
<html>
  <head>
    <title>Chat</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f4f4f4;
      }
      .container {
        max-width: 500px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 0 6px rgba(0,0,0,0.1);
      }
      .home-btn, .reset-btn {
        position: fixed;
        top: 10px;
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        z-index: 1001;
      }
      .home-btn { left: 10px; }
      .reset-btn { right: 10px; background-color: #dc3545; }
      .character-img {
        display: block;
        margin: 0 auto 10px;
        width: 160px;
        height: 160px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid #ccc;
      }
      #charName {
        text-align: center;
        font-size: 18px;
        margin: 10px 0 5px;
      }
      .description {
        text-align: center;
        font-size: 12px;
        color: #555;
        margin-bottom: 20px;
      }
      .chat-area {
        border: 1px solid #ccc;
        border-radius: 8px;
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        margin-bottom: 10px;
        background: #fefefe;
      }
      #messageInput {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-top: 6px;
      }
      #sendBtn {
        margin-top: 6px;
        padding: 8px 12px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      .locked-message {
        text-align: center;
        color: red;
        font-size: 14px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>

    <button class="home-btn" onclick="location.href='index.html'">Go Home</button>
    <button class="reset-btn" onclick="resetConversation()">Start Over</button>

    <div class="container">
      <img id="charImg" class="character-img" src="" alt="Character Image" />
      <h2 id="charName"></h2>
      <div class="description">
        <strong>Description:</strong> <span id="charDesc">Loading...</span>
      </div>

      <div class="chat-area" id="chatbox"></div>

      <div id="lockNotice" class="locked-message" style="display:none;">
        In order to use this feature, please log in.
      </div>

      <input type="text" id="messageInput" placeholder="Type a message..." disabled />
      <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const charName = params.get('name');
      const characters = JSON.parse(localStorage.getItem("characters") || "[]");
      const character = characters.find(c => c.name === charName);
      const user = JSON.parse(localStorage.getItem("loggedInUser"));

      const chatbox = document.getElementById("chatbox");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");

      const historyKey = `chat_history_${user?.username}_${charName}`;
      let chatHistory = [];

      if (!user) {
        document.getElementById("lockNotice").style.display = "block";
      } else {
        messageInput.disabled = false;
        sendBtn.disabled = false;
        loadChatHistory();
      }

      if (character) {
        document.getElementById("charImg").src = character.image;
        document.getElementById("charName").textContent = character.name;
        document.getElementById("charDesc").textContent = character.description;
      }

      function loadChatHistory() {
        const saved = JSON.parse(localStorage.getItem(historyKey) || "[]");
        chatHistory = saved;

        chatHistory.forEach(msg => {
          const div = document.createElement("div");
          div.innerHTML = `<strong style="color:${msg.role === 'user' ? '#007bff' : '#ff6600'}">${msg.role === 'user' ? user.username : character.name}:</strong> ${msg.content}`;
          chatbox.appendChild(div);
        });

        chatbox.scrollTop = chatbox.scrollHeight;
      }

      function saveChatHistory() {
        localStorage.setItem(historyKey, JSON.stringify(chatHistory));
      }

      function resetConversation() {
        if (!confirm("Start over and delete the entire conversation?")) return;
        chatHistory = [];
        localStorage.removeItem(historyKey);
        chatbox.innerHTML = "";
        setupSystemPrompt();
      }

      function setupSystemPrompt() {
        const sfwNote = character.sfw === "NSFW"
          ? "You are allowed to engage in mature or explicit conversations."
          : "Keep all responses safe-for-work, respectful, and appropriate.";

        const toneHint = character.description.toLowerCase().includes("joker") ? 
            "Speak like the Joker from Batman—dark humor, chaos, unpredictable tone." :
            character.description.toLowerCase().includes("yoda") ?
            "Speak like Yoda from Star Wars—wise and backward phrasing." :
            character.description.toLowerCase().includes("iron man") ?
            "Speak like Tony Stark—witty, sarcastic, confident." : 
            "";

        const systemPrompt = `
You are ${character.name}, an AI character created for roleplay.
Description: ${character.description}
Personality: ${character.tags}
${sfwNote}
${toneHint}

Mimic the character's tone, speech style, and vocabulary. Adapt your responses over time and grow more engaging as the chat continues.
Only respond as ${character.name}.
        `.trim();

        chatHistory.push({ role: "system", content: systemPrompt });
      }

      if (chatHistory.length === 0 && user) {
        setupSystemPrompt();
        saveChatHistory();
      }

      async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;

        const msg = document.createElement("div");
        msg.innerHTML = `<strong style="color:#007bff">${user.username}:</strong> ${text}`;
        chatbox.appendChild(msg);
        chatbox.scrollTop = chatbox.scrollHeight;
        messageInput.value = "";

        chatHistory.push({ role: "user", content: text });
        saveChatHistory();

        try {
          const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer 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"
            },
            body: JSON.stringify({
              model: "llama-3.3-70b-versatile",
              messages: chatHistory
            })
          });

          const data = await response.json();
          let aiText = "Hmm...";
          if (data?.choices?.[0]?.message?.content) {
            aiText = data.choices[0].message.content;
            chatHistory.push({ role: "assistant", content: aiText });
            saveChatHistory();
          } else if (data.error) {
            aiText = `Error: ${data.error.message}`;
          }

          const aiReply = document.createElement("div");
          aiReply.innerHTML = `<strong style="color:#ff6600">${character.name}:</strong> ${aiText}`;
          chatbox.appendChild(aiReply);
          chatbox.scrollTop = chatbox.scrollHeight;

        } catch (err) {
          const fail = document.createElement("div");
          fail.innerHTML = `<strong style="color:red">${character.name}:</strong> Failed to contact AI: ${err.message}`;
          chatbox.appendChild(fail);
        }
      }
    </script>
  </body>
</html>
